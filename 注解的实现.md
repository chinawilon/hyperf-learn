# æ³¨è§£çš„å®ç°

> æ³¨è§£æ˜¯`Hyperf`éå¸¸å¼ºå¤§çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡æ³¨è§£çš„å½¢å¼å‡å°‘å¾ˆå¤šçš„é…ç½®ï¼Œä»¥åŠå®ç°å¾ˆå¤šéå¸¸æ–¹ä¾¿çš„åŠŸèƒ½ã€‚  -- hyperf

æ³¨è§£å…¶å®å¯ä»¥ä½¿ç”¨é…ç½®æ¥ä»£æ›¿ï¼ŒPHPæœ¬èº«ä¸æ”¯æŒæ³¨è§£ï¼Œæ¡†æ¶å®ç°çš„è¯­æ³•ç³–ç½¢äº†ã€‚



## æ³¨è§£çš„å½¢å¼

```php
/**
* @AnnotationClass()
**/
```

å¦‚æœè®©æˆ‘ä»¬è‡ªå·±å»å®ç°ä¸€ä¸ªæ³¨è§£åŠŸèƒ½ï¼Œæˆ‘ä»¬çš„æ€è·¯æ˜¯æ€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ

*æˆ‘ä»¬çš„ç¬¬ä¸€ååº”è‚¯å®šæ˜¯ä½¿ç”¨`åå°„`ï¼Œå¯¹æŸä¸ªç±»è¿›è¡Œåå°„ï¼Œæ‹¿åˆ°å®ƒçš„ç±»/å±æ€§/æ–¹æ³•çš„æ³¨é‡Šå¯¹å§ï¼Ÿ*

**ä»£ç ç‰‡æ®µï¼š**

```php
/**
* @AnnotationClass()
**/
class X {
  // pass
}

$z = new ReflectionClass('X');
echo $z->getName(); // X
echo $z->getDocComment(); //@AnnotationClass()
```



## æ”¶é›†ä½¿ç”¨äº†æ³¨è§£ç±»çš„ç±»

ğŸ¤”è¯•æƒ³ï¼Ÿ

æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°„æ‹¿åˆ°`æ³¨è§£ç±»`ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬è‚¯å®šæ˜¯éœ€è¦æŠŠè¿™ä¸ªç±»å’Œ`æ³¨è§£ç±»`å…³è”èµ·æ¥ã€‚æˆ‘ä»¬ä¼šæƒ³åˆ°è°ƒç”¨`æ³¨è§£ç±»`çš„æ–¹æ³•æ¥`æ”¶é›†`ä½¿ç”¨äº†å®ƒä»¬çš„ç±»ã€‚è¿™é‡Œéœ€è¦åŒºåˆ†æ˜¯ç±»ä½¿ç”¨äº†ï¼Œè¿˜æ˜¯æ–¹æ³•æˆ–è€…æ˜¯å±æ€§ä½¿ç”¨äº†æ³¨è§£ã€‚

åœ¨`Hyperf`æ¡†æ¶ä¸­ï¼Œæ‰€æœ‰çš„æ³¨è§£ç±»éƒ½å®ç°äº†`AnnotationInterface`æ¥å£ã€‚

æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š(æ— å…³ä»£ç çœç•¥)

```php
interface AnnotationInterface
{
    public function collectClass(string $className): void;
    public function collectMethod(string $className, ?string $target): void;
    public function collectProperty(string $className, ?string $target): void;
}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ³¨è§£ç±»æœ€å°‘æœ‰3ä¸ªæ–¹æ³•ï¼Œå…¶ä¸­æ˜æ˜¾çœ‹å‡ºï¼Œå¦‚æœæ˜¯ç±»ä½¿ç”¨äº†æ³¨è§£ï¼Œå°±è°ƒç”¨`collectClass`æ–¹æ³•æ”¶é›†ï¼Œå¦‚æœæ˜¯æ–¹æ³•å°±è°ƒç”¨`collectMethod`æ–¹æ³•æ”¶é›†, å¦‚æœæ˜¯å±æ€§å°±è°ƒç”¨`collectProperty`æ–¹æ³•æ”¶é›†ã€‚

è¿™é‡Œè¯´åˆ°äº†ä¸€ä¸ª`æ”¶é›†`ï¼Œåœ¨Hyperfé‡Œé¢ä½¿ç”¨äº†ä¸€ä¸ªå«åš`æ”¶é›†ç±»Collector`çš„æ¦‚å¿µï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸€ä¸ª`Annotation`å°±å¯¹åº”ä¸€ä¸ª`AnnotationCollector`ã€‚å®é™…ä¸Šä¹Ÿå¯ä»¥ä½¿ç”¨æ³¨è§£ç±»è‡ªå·±æ”¶é›†ï¼Œæ¯”å¦‚ä½¿ç”¨æŸä¸ªå±æ€§å­˜å‚¨ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªè®¾è®¡é—®é¢˜ã€‚



## è°ä½¿ç”¨äº†æ³¨è§£ï¼Ÿ

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ˜¯ä¸çŸ¥é“è°ä½¿ç”¨äº†æ³¨è§£çš„ï¼Œå› ä¸ºå®ƒä¸æ˜¯è¯­è¨€ç‰¹æ€§ï¼Œé™¤éè‡ªå·±å£°æ˜ã€‚

åœ¨`hyperf`ä¸­ï¼ŒæŒ‡å®šäº†é…ç½®æ–‡ä»¶`config/autoload/annotations`å£°æ˜äº†æ³¨è§£ç±»ï¼Œä»¥åŠä½¿ç”¨äº†æ³¨è§£ç±»çš„`è·¯å¾„`ï¼Œå’Œå…¶ä»–ä¸€äº›ä¸æ³¨è§£è¡Œä¸ºæœ‰å…³çš„å±æ€§ã€‚åœ¨åŒ…é‡Œé¢ä¹Ÿå¯ä»¥é€šçš„`ConfigProvider`è¿”å›é…ç½®æ•°ç»„ï¼Œå…¶ä¸­`annotations`æ˜¯å¯¹æ³¨è§£çš„ç›¸å…³é…ç½®ã€‚

```php
# annotations.php
return [
    'scan' => [
        'paths' => [
            BASE_PATH . '/app',
        ],
        'ignore_annotations' => [
            'mixin',
        ],
    ],
];

# ConfigProvider.php
return [
  'annotations' => [
    'scan' => [
      'paths' => [
        __DIR__,
      ],
      'collectors' => [
        AnnotationCollector::class,
        AspectCollector::class,
      ],
    ],
    'ignore_annotations' => [
      'mixin',
    ],
  ],
];


```

å¯ä»¥çœ‹åˆ°ï¼Œ`annotations`ç”³æ˜äº†`app`ç›®å½•ä¸‹çš„ç±»ä½¿ç”¨äº†æ³¨è§£ï¼Œä»¥åŠåŒ…é‡Œé¢æŒ‡å®šçš„è·¯å¾„ã€‚

é‚£ä¹ˆè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥`æ‰«æ`è¿™äº›è·¯å¾„ï¼Œç„¶åé€šè¿‡åå°„æ¥è·å–æ‰€æœ‰æ³¨è§£ç±»ä»¥åŠä½¿ç”¨äº†å®ƒä»¬çš„ç±»ã€‚

å…¶ä¸­æœ‰ä¸€ä¸ª`collectors`å­—æ®µï¼Œæ˜¯å¯¹`æ”¶é›†å™¨`çš„ç”³æ˜ï¼Œç”¨äºä¸€å®šçš„æ€§èƒ½ä¼˜åŒ–ã€‚ç”±äºæ”¶é›†å™¨æ˜¯å­˜å‚¨æ³¨è§£ç±»å’Œä½¿ç”¨äº†æ³¨è§£ç±»çš„ç±»çš„å®¹å™¨ï¼Œæ‰€ä»¥è¿™ä¸ªç±»å¯èƒ½ä¼šéå¸¸å¤§ã€‚è€Œä¸”æ•´ä¸ªè§£æè¿‡ç¨‹éå¸¸ä½æ•ˆï¼Œæ‰€ä»¥ä½¿ç”¨ä¸€å®šçš„ç¼“å­˜æ–‡ä»¶æ¥ç¼“å­˜è¿™ä¸ªæ”¶é›†ç»“æœã€‚

ä¸‹é¢æ˜¯`hyperf`æ‰«æå’Œæ”¶é›†çš„é€»è¾‘ã€‚

```php
// Scanner.php
// æ‰«æ
public function scan(): array
{
        $paths = $this->scanConfig->getPaths(); // è¿™é‡Œå°±æ˜¯æŒ‡å®šçš„ä½¿ç”¨äº†æ³¨è§£ç±»çš„è·¯å¾„
        $collectors = $this->scanConfig->getCollectors();
  			$classes = [];
        if (! $paths) {
            return $classes;
        }
        $annotationReader = new AnnotationReader();
        $lastCacheModified = $this->deserializeCachedCollectors($collectors);
        if ($lastCacheModified > 0 && $this->scanConfig->isCacheable()) {
            return [];
        }
        $paths = $this->normalizeDir($paths);
        $reflector = BetterReflectionManager::initClassReflector($paths); // åå°„æ‰€åœ¨è·¯å¾„çš„ç±»
        $classes = $reflector->getAllClasses(); // è·å–æ‰€æœ‰åå°„ç±»
  			// Initialize cache for BetterReflectionManager.
        foreach ($classes as $class) {
            BetterReflectionManager::reflectClass($class->getName(), $class);
        }
        $this->clearRemovedClasses($collectors, $classes);
        foreach ($classes as $reflectionClass) {
            if ($this->filesystem->lastModified($reflectionClass->getFileName()) >= $lastCacheModified) {
                /** @var MetadataCollector $collector */
                foreach ($collectors as $collector) {
                    $collector::clear($reflectionClass->getName());
                }
              	// å¼€å§‹æ”¶é›†
                $this->collect($annotationReader, $reflectionClass);
            }
        }
  			...
}

// Scanner.php
// æ”¶é›†
public function collect(AnnotationReader $reader, ReflectionClass $reflection)
    {
				...
        $classAnnotation->collectClass($className);
				...
        $propertyAnnotation->collectProperty($className, $property->getName());
				...
        $methodAnnotation->collectMethod($className, $method->getName());
                  
}
```



## æ€ä¹ˆä½¿ç”¨è¿™ä¸ªæ”¶é›†å™¨ï¼Ÿ

å› ä¸ºæ³¨è§£ç±»å’Œä½¿ç”¨äº†è¿™ä¸ªæ³¨è§£ç±»çš„ç±»çš„å…³ç³»è¢«æˆ‘ä»¬å­˜å‚¨åœ¨äº†æ”¶é›†å™¨é‡Œé¢ã€‚é‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨ä½¿ç”¨çš„æ—¶å€™è°ƒç”¨è¿™ä¸ª`æ”¶é›†å™¨`å°±å¯ä»¥äº†ã€‚

ä¸‹é¢æ˜¯ä½¿ç”¨æ³¨è§£ç±»`Command`çš„ä¾‹å­ï¼Œè¿™ä¸ªæ³¨è§£ä½¿ç”¨äº†é»˜è®¤çš„`AnnotationCollector`æ”¶é›†å™¨ã€‚

```php
class ApplicationFactory
{
    public function __invoke(ContainerInterface $container)
    {
        if ($container->has(EventDispatcherInterface::class)) {
            $eventDispatcher = $container->get(EventDispatcherInterface::class);
            $eventDispatcher->dispatch(new BootApplication());
        }

        $config = $container->get(ConfigInterface::class);
        $commands = $config->get('commands', []);
        // Append commands that defined by annotation.
        $annotationCommands = [];
      
       	// è¿™é‡Œè°ƒç”¨äº†æ”¶é›†å™¨ï¼Œæ‰€æœ‰ä½¿ç”¨äº†Comamndè¿™ä¸ªæ³¨è§£ç±»çš„ç±»ã€‚
        if (class_exists(AnnotationCollector::class) && class_exists(Command::class)) {
            $annotationCommands = AnnotationCollector::getClassesByAnnotation(Command::class);
            $annotationCommands = array_keys($annotationCommands);
        }

        $commands = array_unique(array_merge($commands, $annotationCommands));
        $application = new Application();

        if (isset($eventDispatcher) && class_exists(SymfonyEventDispatcher::class)) {
            $application->setDispatcher(new SymfonyEventDispatcher($eventDispatcher));
        }

        foreach ($commands as $command) {
            $application->add($container->get($command));
        }
        return $application;
    }
}
```

ä¸‹é¢æ˜¯å¸¸ç”¨çš„`Controller`å’Œ`AutoController`ä»¥åŠ`Middleware`è·¯ç”±æ³¨è§£å™¨çš„ä¾‹å­

å…ˆçœ‹ä¸‹æ³¨è§£å™¨çš„å®šä¹‰

```php
// AutoController
declare(strict_types=1);
namespace Hyperf\HttpServer\Annotation;
use Hyperf\Di\Annotation\AbstractAnnotation;

/**
 * @Annotation
 * @Target({"CLASS"})
 */
class AutoController extends AbstractAnnotation
{
    public $prefix = '';
    public $server = 'http';
    public $options = [];
}

// Controller.php
declare(strict_types=1);
namespace Hyperf\HttpServer\Annotation;
use Hyperf\Di\Annotation\AbstractAnnotation;

/**
 * @Annotation
 * @Target({"CLASS"})
 */
class Controller extends AbstractAnnotation
{
    public $prefix = '';
    public $server = 'http';
    public $options = [];
}

// Middleware.php
declare(strict_types=1);
namespace Hyperf\HttpServer\Annotation;
use Hyperf\Di\Annotation\AbstractAnnotation;

/**
 * @Annotation
 * @Target({"ALL"})
 */
class Middlewares extends AbstractAnnotation
{
    public $middlewares = [];
    public function __construct($value = null)
    {
        $this->bindMainProperty('middlewares', $value);
    }
}
```

2ä¸ªControlleræ³¨è§£ç±»æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œä¸€èˆ¬ä¸€ä¸ªæ˜¯ç”¨äºæ•´ä¸ªç±»ï¼Œä¸€ä¸ªæ˜¯ç”¨äºæ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½åŒæ—¶ä½¿ç”¨2ä¸ªæ³¨è§£ã€‚

ä¸‹é¢æ˜¯è·¯ç”±çš„åˆå§‹åŒ–ï¼š

```php
// Router.php
declare(strict_types=1);
namespace Hyperf\HttpServer\Router;
class Router
{
    protected static $serverName = 'http';
    protected static $factory;
    public static function __callStatic($name, $arguments)
    {
        $router = static::$factory->getRouter(static::$serverName);
        return $router->{$name}(...$arguments);
    }

    public static function addServer(string $serverName, callable $callback)
    {
        static::$serverName = $serverName;
        call($callback);
        static::$serverName = 'http';
    }

  	// åˆå§‹åŒ–
    public static function init(DispatcherFactory $factory)
    {
        static::$factory = $factory;
    }
}
```

```php
// DispatcherFactory.php
class DispatcherFactory
{
  ...
    public function __construct()
    {
        $this->initAnnotationRoute(AnnotationCollector::list());
        $this->initConfigRoute();
    }
  ...
  protected function initAnnotationRoute(array $collector): void,{}
  
  protected function handleAutoController(string $className, AutoController $annotation, array $middlewares = [], array $methodMetadata = []): void {}
  
  protected function handleController(string $className, Controller $annotation, array $methodMetadata, array $middlewares = []): void {}
  	
```

ä¸Šé¢æ˜¯åˆ©ç”¨æ”¶é›†å™¨æ‰¾å‡ºæ‰€æœ‰ä½¿ç”¨äº†è¿™å‡ ä¸ªæ³¨è§£ç±»çš„ç±»ï¼Œç„¶ååå°„ä½¿ç”¨äº†å®ƒçš„ç±»ï¼Œç„¶åæ³¨å†Œåˆ°è·¯ç”±é‡Œé¢ã€‚

å®é™…ä¸Šå†™ä¸ªè·¯ç”±è¡¨ä¼šæ­»äººå—ï¼ŸèŠ±é‡Œèƒ¡å“¨çš„ã€‚ã€‚ã€‚



## æ€»ç»“

1. åœ¨é…ç½®æ–‡ä»¶æˆ–ConfigProvideré‡Œé¢ç”³æ˜æ³¨è§£å’Œæ‰«æè·¯å¾„ã€‚
2. é€šè¿‡åå°„æ‰«æè·¯å¾„è·å–åˆ°æ‰€æœ‰åå°„ç±»ï¼Œç„¶åä¾æ¬¡è°ƒç”¨å®ƒç”³æ˜çš„æ³¨è§£ç±»è¿›è¡Œç›¸å…³æ”¶é›†ã€‚
3. ç±»/å±æ€§/æ–¹æ³•çš„æ³¨è§£ï¼Œè°ƒç”¨æ³¨è§£ç±»çš„collectClass/collectMethod/collectPropertyè¿›è¡Œæ”¶é›†ã€‚
4. åœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œè°ƒç”¨æ”¶é›†å™¨è¿›è¡Œè·å–ï¼Œç„¶åæ‰§è¡Œç›¸å…³é€»è¾‘ã€‚